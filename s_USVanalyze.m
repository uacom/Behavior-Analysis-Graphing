function Results = s_USVanalyze(wave,excel,zoomTimes)
%% Generate figure for USV analysis (uses already-classified USVs from spreadsheet)
%
% INPUTS
% wave = .wav file with USVs
% excel = spreadsheet containing USV statistics and classifications
% zoomTimes = windows to zoom into for different figures, separated by semicolons (ex. [1.2 2.5 ; 6.7 8.7 ; 10.4 25.3])
%
% OUTPUTS frequency of each class of USV in both count and percentage

%%% DEBUGGING
%%% wave = 'F:\USV\T0000694.wav';
%%% excel = 'usvStats.xlsx';
%%% zoomTimes = [140.6 142.5; 144.92 146.3];
%%% Results = s_USVanalyze('E:\My Documents\MATLAB\T0000591-3-P7 3.wav','E:\My Documents\MATLAB\T0000591-3-P7 3.xlsx',[58 62.5; 144.92 146.3]);

%%% for file locations on home computer
%%% Results = s_USVanalyze('C:\Users\Shenfeng Qiu\Documents\MATLAB\T0000591-3-P7 3.wav','C:\Users\Shenfeng Qiu\Documents\MATLAB\T0000591-3-P7 3.xlsx',[58 62.5; 144.92 146.3]);

%   autoArrageFigures(0, 0, 2)

%%

cmap = [1,1,1;0.999938726425171,0.999938726425171,0.999938726425171;0.999877452850342,0.999877452850342,0.999877452850342;0.999816179275513,0.999816179275513,0.999816179275513;0.999754905700684,0.999754905700684,0.999754905700684;0.999693632125855,0.999693632125855,0.999693632125855;0.999632358551025,0.999632358551025,0.999632358551025;0.999571084976196,0.999571084976196,0.999571084976196;0.999509811401367,0.999509811401367,0.999509811401367;0.999448537826538,0.999448537826538,0.999448537826538;0.999387264251709,0.999387264251709,0.999387264251709;0.999325990676880,0.999325990676880,0.999325990676880;0.999264717102051,0.999264717102051,0.999264717102051;0.999203443527222,0.999203443527222,0.999203443527222;0.999142169952393,0.999142169952393,0.999142169952393;0.999080896377564,0.999080896377564,0.999080896377564;0.999019622802734,0.999019622802734,0.999019622802734;0.998958349227905,0.998958349227905,0.998958349227905;0.998897075653076,0.998897075653076,0.998897075653076;0.998835802078247,0.998835802078247,0.998835802078247;0.998774528503418,0.998774528503418,0.998774528503418;0.998713254928589,0.998713254928589,0.998713254928589;0.998651981353760,0.998651981353760,0.998651981353760;0.998590707778931,0.998590707778931,0.998590707778931;0.998529434204102,0.998529434204102,0.998529434204102;0.998468160629273,0.998468160629273,0.998468160629273;0.998406887054443,0.998406887054443,0.998406887054443;0.998345613479614,0.998345613479614,0.998345613479614;0.998284339904785,0.998284339904785,0.998284339904785;0.998223066329956,0.998223066329956,0.998223066329956;0.998161792755127,0.998161792755127,0.998161792755127;0.998100519180298,0.998100519180298,0.998100519180298;0.998039245605469,0.998039245605469,0.998039245605469;0.997977912425995,0.997977912425995,0.997977912425995;0.997916638851166,0.997916638851166,0.997916638851166;0.997855365276337,0.997855365276337,0.997855365276337;0.997794091701508,0.997794091701508,0.997794091701508;0.997732818126679,0.997732818126679,0.997732818126679;0.997671544551849,0.997671544551849,0.997671544551849;0.997610270977020,0.997610270977020,0.997610270977020;0.997548997402191,0.997548997402191,0.997548997402191;0.997487723827362,0.997487723827362,0.997487723827362;0.997426450252533,0.997426450252533,0.997426450252533;0.997365176677704,0.997365176677704,0.997365176677704;0.997303903102875,0.997303903102875,0.997303903102875;0.997242629528046,0.997242629528046,0.997242629528046;0.997181355953217,0.997181355953217,0.997181355953217;0.997120082378388,0.997120082378388,0.997120082378388;0.997058808803558,0.997058808803558,0.997058808803558;0.996997535228729,0.996997535228729,0.996997535228729;0.996936261653900,0.996936261653900,0.996936261653900;0.996874988079071,0.996874988079071,0.996874988079071;0.996813714504242,0.996813714504242,0.996813714504242;0.996752440929413,0.996752440929413,0.996752440929413;0.996691167354584,0.996691167354584,0.996691167354584;0.996629893779755,0.996629893779755,0.996629893779755;0.996568620204926,0.996568620204926,0.996568620204926;0.996507346630096,0.996507346630096,0.996507346630096;0.996446073055267,0.996446073055267,0.996446073055267;0.996384799480438,0.996384799480438,0.996384799480438;0.996323525905609,0.996323525905609,0.996323525905609;0.996262252330780,0.996262252330780,0.996262252330780;0.996200978755951,0.996200978755951,0.996200978755951;0.996139705181122,0.996139705181122,0.996139705181122;0.996078431606293,0.996078431606293,0.996078431606293;0.988572955131531,0.988572955131531,0.988572955131531;0.981067419052124,0.981067419052124,0.981067419052124;0.973561942577362,0.973561942577362,0.973561942577362;0.966056466102600,0.966056466102600,0.966056466102600;0.958550930023193,0.958550930023193,0.958550930023193;0.951045453548431,0.951045453548431,0.951045453548431;0.943539977073669,0.943539977073669,0.943539977073669;0.936034440994263,0.936034440994263,0.936034440994263;0.928528964519501,0.928528964519501,0.928528964519501;0.921023488044739,0.921023488044739,0.921023488044739;0.913517951965332,0.913517951965332,0.913517951965332;0.906012475490570,0.906012475490570,0.906012475490570;0.898506999015808,0.898506999015808,0.898506999015808;0.891001462936401,0.891001462936401,0.891001462936401;0.883495986461639,0.883495986461639,0.883495986461639;0.875990509986877,0.875990509986877,0.875990509986877;0.868484973907471,0.868484973907471,0.868484973907471;0.860979497432709,0.860979497432709,0.860979497432709;0.853474020957947,0.853474020957947,0.853474020957947;0.845968484878540,0.845968484878540,0.845968484878540;0.838463008403778,0.838463008403778,0.838463008403778;0.830957531929016,0.830957531929016,0.830957531929016;0.823451995849609,0.823451995849609,0.823451995849609;0.815946519374847,0.815946519374847,0.815946519374847;0.808441042900085,0.808441042900085,0.808441042900085;0.800935506820679,0.800935506820679,0.800935506820679;0.793430030345917,0.793430030345917,0.793430030345917;0.785924553871155,0.785924553871155,0.785924553871155;0.778419017791748,0.778419017791748,0.778419017791748;0.770913541316986,0.770913541316986,0.770913541316986;0.763408064842224,0.763408064842224,0.763408064842224;0.755902528762817,0.755902528762817,0.755902528762817;0.748397052288055,0.748397052288055,0.748397052288055;0.740891575813294,0.740891575813294,0.740891575813294;0.733386039733887,0.733386039733887,0.733386039733887;0.725880563259125,0.725880563259125,0.725880563259125;0.718375086784363,0.718375086784363,0.718375086784363;0.710869550704956,0.710869550704956,0.710869550704956;0.703364074230194,0.703364074230194,0.703364074230194;0.695858597755432,0.695858597755432,0.695858597755432;0.688353061676025,0.688353061676025,0.688353061676025;0.680847585201263,0.680847585201263,0.680847585201263;0.673342108726502,0.673342108726502,0.673342108726502;0.665836572647095,0.665836572647095,0.665836572647095;0.658331096172333,0.658331096172333,0.658331096172333;0.650825619697571,0.650825619697571,0.650825619697571;0.643320083618164,0.643320083618164,0.643320083618164;0.635814607143402,0.635814607143402,0.635814607143402;0.628309130668640,0.628309130668640,0.628309130668640;0.620803594589233,0.620803594589233,0.620803594589233;0.613298118114471,0.613298118114471,0.613298118114471;0.605792641639710,0.605792641639710,0.605792641639710;0.598287105560303,0.598287105560303,0.598287105560303;0.590781629085541,0.590781629085541,0.590781629085541;0.583276152610779,0.583276152610779,0.583276152610779;0.575770616531372,0.575770616531372,0.575770616531372;0.568265140056610,0.568265140056610,0.568265140056610;0.560759663581848,0.560759663581848,0.560759663581848;0.553254127502441,0.553254127502441,0.553254127502441;0.545748651027679,0.545748651027679,0.545748651027679;0.538243174552918,0.538243174552918,0.538243174552918;0.530737638473511,0.530737638473511,0.530737638473511;0.523232161998749,0.523232161998749,0.523232161998749;0.515726685523987,0.515726685523987,0.515726685523987;0.508221149444580,0.508221149444580,0.508221149444580;0.500715672969818,0.500715672969818,0.500715672969818;0.493210166692734,0.493210166692734,0.493210166692734;0.485704660415649,0.485704660415649,0.485704660415649;0.478199183940887,0.478199183940887,0.478199183940887;0.470693677663803,0.470693677663803,0.470693677663803;0.463188171386719,0.463188171386719,0.463188171386719;0.455682694911957,0.455682694911957,0.455682694911957;0.448177188634872,0.448177188634872,0.448177188634872;0.440671682357788,0.440671682357788,0.440671682357788;0.433166205883026,0.433166205883026,0.433166205883026;0.425660699605942,0.425660699605942,0.425660699605942;0.418155193328857,0.418155193328857,0.418155193328857;0.410649716854095,0.410649716854095,0.410649716854095;0.403144210577011,0.403144210577011,0.403144210577011;0.395638704299927,0.395638704299927,0.395638704299927;0.388133227825165,0.388133227825165,0.388133227825165;0.380627721548080,0.380627721548080,0.380627721548080;0.373122215270996,0.373122215270996,0.373122215270996;0.365616738796234,0.365616738796234,0.365616738796234;0.358111232519150,0.358111232519150,0.358111232519150;0.350605726242065,0.350605726242065,0.350605726242065;0.343100249767303,0.343100249767303,0.343100249767303;0.335594743490219,0.335594743490219,0.335594743490219;0.328089237213135,0.328089237213135,0.328089237213135;0.320583760738373,0.320583760738373,0.320583760738373;0.313078254461288,0.313078254461288,0.313078254461288;0.305572748184204,0.305572748184204,0.305572748184204;0.298067271709442,0.298067271709442,0.298067271709442;0.290561765432358,0.290561765432358,0.290561765432358;0.287643730640411,0.287643730640411,0.287643730640411;0.284725695848465,0.284725695848465,0.284725695848465;0.281807661056519,0.281807661056519,0.281807661056519;0.278889626264572,0.278889626264572,0.278889626264572;0.275971591472626,0.275971591472626,0.275971591472626;0.273053526878357,0.273053526878357,0.273053526878357;0.270135492086411,0.270135492086411,0.270135492086411;0.267217457294464,0.267217457294464,0.267217457294464;0.264299422502518,0.264299422502518,0.264299422502518;0.261381387710571,0.261381387710571,0.261381387710571;0.258463352918625,0.258463352918625,0.258463352918625;0.255545318126678,0.255545318126678,0.255545318126678;0.252627283334732,0.252627283334732,0.252627283334732;0.249709233641624,0.249709233641624,0.249709233641624;0.246791198849678,0.246791198849678,0.246791198849678;0.243873164057732,0.243873164057732,0.243873164057732;0.240955129265785,0.240955129265785,0.240955129265785;0.238037079572678,0.238037079572678,0.238037079572678;0.235119044780731,0.235119044780731,0.235119044780731;0.232201009988785,0.232201009988785,0.232201009988785;0.229282975196838,0.229282975196838,0.229282975196838;0.226364940404892,0.226364940404892,0.226364940404892;0.223446890711784,0.223446890711784,0.223446890711784;0.220528855919838,0.220528855919838,0.220528855919838;0.217610821127892,0.217610821127892,0.217610821127892;0.214692786335945,0.214692786335945,0.214692786335945;0.211774751543999,0.211774751543999,0.211774751543999;0.208856701850891,0.208856701850891,0.208856701850891;0.205938667058945,0.205938667058945,0.205938667058945;0.203020632266998,0.203020632266998,0.203020632266998;0.200102597475052,0.200102597475052,0.200102597475052;0.197184562683105,0.197184562683105,0.197184562683105;0.194266512989998,0.194266512989998,0.194266512989998;0.191348478198051,0.191348478198051,0.191348478198051;0.188430443406105,0.188430443406105,0.188430443406105;0.185512408614159,0.185512408614159,0.185512408614159;0.182594373822212,0.182594373822212,0.182594373822212;0.179676324129105,0.179676324129105,0.179676324129105;0.176758289337158,0.176758289337158,0.176758289337158;0.173840254545212,0.173840254545212,0.173840254545212;0.170922219753265,0.170922219753265,0.170922219753265;0.168004184961319,0.168004184961319,0.168004184961319;0.165086135268211,0.165086135268211,0.165086135268211;0.162168100476265,0.162168100476265,0.162168100476265;0.159250065684319,0.159250065684319,0.159250065684319;0.156332030892372,0.156332030892372,0.156332030892372;0.153413996100426,0.153413996100426,0.153413996100426;0.150495946407318,0.150495946407318,0.150495946407318;0.147577911615372,0.147577911615372,0.147577911615372;0.144659876823425,0.144659876823425,0.144659876823425;0.141741842031479,0.141741842031479,0.141741842031479;0.138823807239532,0.138823807239532,0.138823807239532;0.135905757546425,0.135905757546425,0.135905757546425;0.132987722754478,0.132987722754478,0.132987722754478;0.130069687962532,0.130069687962532,0.130069687962532;0.127151653170586,0.127151653170586,0.127151653170586;0.124233610928059,0.124233610928059,0.124233610928059;0.121315576136112,0.121315576136112,0.121315576136112;0.118397533893585,0.118397533893585,0.118397533893585;0.115479499101639,0.115479499101639,0.115479499101639;0.112561464309692,0.112561464309692,0.112561464309692;0.109643422067165,0.109643422067165,0.109643422067165;0.106725387275219,0.106725387275219,0.106725387275219;0.103807345032692,0.103807345032692,0.103807345032692;0.100889310240746,0.100889310240746,0.100889310240746;0.0979712754487991,0.0979712754487991,0.0979712754487991;0.0950532332062721,0.0950532332062721,0.0950532332062721;0.0921351984143257,0.0921351984143257,0.0921351984143257;0.0892171636223793,0.0892171636223793,0.0892171636223793;0.0862991213798523,0.0862991213798523,0.0862991213798523;0.0833810865879059,0.0833810865879059,0.0833810865879059;0.0804630443453789,0.0804630443453789,0.0804630443453789;0.0775450095534325,0.0775450095534325,0.0775450095534325;0.0746269747614861,0.0746269747614861,0.0746269747614861;0.0717089325189591,0.0717089325189591,0.0717089325189591;0.0687908977270126,0.0687908977270126,0.0687908977270126;0.0658728554844856,0.0658728554844856,0.0658728554844856;0.0629548206925392,0.0629548206925392,0.0629548206925392;0.0600367821753025,0.0600367821753025,0.0600367821753025;0.0571187436580658,0.0571187436580658,0.0571187436580658;0.0542007051408291,0.0542007051408291,0.0542007051408291;0.0512826703488827,0.0512826703488827,0.0512826703488827;0.0483646318316460,0.0483646318316460,0.0483646318316460;0.0454465933144093,0.0454465933144093,0.0454465933144093;0.0425285547971725,0.0425285547971725,0.0425285547971725;0.0396105162799358,0.0396105162799358,0.0396105162799358;0.0366924814879894,0.0366924814879894,0.0366924814879894;0.0337744429707527,0.0337744429707527,0.0337744429707527;0.0308564044535160,0.0308564044535160,0.0308564044535160;0.0279383677989244,0.0279383677989244,0.0279383677989244;0.0250203292816877,0.0250203292816877,0.0250203292816877;0.0221022907644510,0.0221022907644510,0.0221022907644510;0.0191842541098595,0.0191842541098595,0.0191842541098595;0.0162662155926228,0.0162662155926228,0.0162662155926228;0.0133481780067086,0.0133481780067086,0.0133481780067086;0.0104301404207945,0.0104301404207945,0.0104301404207945;0,0,0];
colororder = get(gca,'colororder');
[rsound,fs] = audioread(wave);
rsheet = xlsread(excel);
class = rsheet(:,2); % USV classifications
numEvents = length(class);
ts = rsheet(:,5:6); % start and end times for USVs
dt = 1/fs;
numZoom = size(zoomTimes,1);

figure(1)
%%%%%%%%%%%%%%%%%%%%%%FOR LEGEND CREATION%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
lgd(1) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],'r','EdgeColor','r');
lgd(2) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],[0 0.6 0],'EdgeColor',[0 0.6 0]);
lgd(3) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],'b','EdgeColor','b');
lgd(4) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(1,:),'EdgeColor',colororder(1,:));
lgd(5) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(2,:),'EdgeColor',colororder(2,:));
lgd(6) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(3,:),'EdgeColor',colororder(3,:));
lgd(7) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(4,:),'EdgeColor',colororder(4,:));
lgd(8) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(5,:),'EdgeColor',colororder(5,:));
lgd(9) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(6,:),'EdgeColor',colororder(6,:));
lgd(10) = patch([NaN NaN NaN NaN],[NaN NaN NaN NaN],colororder(7,:),'EdgeColor',colororder(7,:));
hold on
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

traceLength = length(rsound)/fs;
x = dt:dt:traceLength;
plot(x,rsound)

for i=1:numEvents
    pch = patch([ts(i,1) ts(i,2) ts(i,2) ts(i,1)],[0.1 0.1 0.2 0.2],'k');
    switch class(i)
        case 1
            pch.FaceColor = 'r';
            pch.EdgeColor = 'r';
        case 2
            pch.FaceColor = [0 0.6 0];
            pch.EdgeColor = [0 0.6 0];
        case 3
            pch.FaceColor = 'b';
            pch.EdgeColor = 'b';
        case 4
            pch.FaceColor = colororder(1,:);
            pch.EdgeColor = colororder(1,:);
        case 5
            pch.FaceColor = colororder(2,:);
            pch.EdgeColor = colororder(2,:);
        case 6
            pch.FaceColor = colororder(3,:);
            pch.EdgeColor = colororder(3,:);
        case 7
            pch.FaceColor = colororder(4,:);
            pch.EdgeColor = colororder(4,:);
        case 8
            pch.FaceColor = colororder(5,:);
            pch.EdgeColor = colororder(5,:);
        case 9
            pch.FaceColor = colororder(6,:);
            pch.EdgeColor = colororder(6,:);
        case 10
            pch.FaceColor = colororder(7,:);
            pch.EdgeColor = colororder(7,:);
    end
end
legend(lgd,{'Short','Upward','Downward','Flat','Chevron','Complex','Two-syllable','Frequency Step','Composite','Harmonic'},'Location','southeast')
xlabel('Time (sec)')
ylabel('Amplitude')
title('USV Whole Trace')

for i=1:numZoom
    figure(i+1)
    [~,F,T,P] = spectrogram(rsound,1000,700,[],fs,'yaxis');
    imagesc(T, F./1000, 10*log10(P+eps))
    axis xy
    xlim([zoomTimes(i,1) zoomTimes(i,2)])
    cbar = colorbar;
    colormap(cmap)
    ylabel('Frequency (kHz)')
    xlabel('Time (s)')
    cbar.Label.String = 'Power/frequency (db/Hz)';
    for j=1:numEvents
        line([ts(j,1) ts(j,2)],[135 135],'Color','k');
     switch class(j) % for replacing numbers with text
        case 6
            text(ts(j,1),145,'Complex')
        case 3
            text(ts(j,1),145,'Downward')
        case 5
            text(ts(j,1),145,'Chevron')
        case 4
            text(ts(j,1),145,'Flat')
        case 9
            text(ts(j,1),145,'Composite')
        case 8
            text(ts(j,1),145,'Frequency Step')
        case 2
            text(ts(j,1),145,'Upward')
        case 1
            text(ts(j,1),145,'Short')
        case 10
            text(ts(j,1),145,'Harmonic')
        case 7
            text(ts(j,1),145,'Two-Syllable')
    end
    end 
end

figcount = i+2;
figure(figcount) % bar chart of vocalizations
clgth(10)=0;
for i=1:10
    clgth(i) = length(find(class==i));
end
bar(clgth,'FaceColor','none','LineWidth',2)
xticklabels({'Short','Upward','Downward','Flat','Chevron','Complex','Two-syllable','Frequency Step','Composite','Harmonic'})
xtickangle(45)
ylabel('Number of vocalizations')
xlabel('USV Class')
title('# vocalizations per class')

figure(figcount+1)
pcent = (clgth./length(class)).*100;
bar(pcent,'FaceColor','none','LineWidth',2)
xticklabels({'Short','Upward','Downward','Flat','Chevron','Complex','Two-syllable','Frequency Step','Composite','Harmonic'})
xtickangle(45)
ylabel('Percentage (%)')
xlabel('USV Class')
title('Percent vocalizations per class')

Results(:,1) = 1:10;
Results(:,2) = clgth';
Results(:,3) = pcent';

xlswrite(excel,Results,'analysis')


end